---
title: "Mortality Trends Among Shelter Residents in Toronto: A Longitudinal Study from 2007 to 2024"
author: 
  - Fangning Zhang
thanks: "Code and data are available at: https://github.com/FangningZhang81/Deaths-of-Shelter-Residents."
date: today
date-format: long
abstract: "First sentence. Second sentence. Third sentence. Fourth sentence."
format: pdf
number-sections: true
bibliography: references.bib
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
#hide the code in the PDF

```

```{r}
#| include: false
#| warning: false
#| message: false
library(knitr)
library(kableExtra)
library(tidyverse)
```


# Introduction

You can and should cross-reference sections and sub-sections. We use @citeR and @rohan.

The remainder of this paper is structured as follows. @sec-data....



# Data {#sec-data}

## Overview
The dataset used in this study is titled "Deaths of Shelter Residents". The dataset is published by the Toronto Shelter and Support Services Department and is obtained from OpenDataToronto (@opendatatorotno). It covers the deaths of shelter residents from 2007 to the present and is still updated monthly. Variables such as the total number of decedents and the breakdown of deaths by gender (male, female, transgender/non-binary/two-spirit) are included. All death counts are reported on a monthly basis. For privacy and ethical reasons, the dataset does not contain any personally identifiable information. 

A dataset titled "Death Registry Statistics" is also found on OpenDataToronto (@opendatatorotno). The dataset is related to the study, but the variables are too general. For example, information on the number of deaths among vulnerable populations cannot be found in this dataset. The dataset titled "Fatal and non-fatal suspected opioid overdoses in the shelter system" also found on OpenDataToronto (@opendatatorotno) can be a helper dataset. Since it only covers one specific cause of death, it cannot serve as the primary dataset for the study.

A @tbl-raw with first few rows is shown below, which can give an overview of the raw data and variables.

```{r}
#| warning: false
#| message: false
#| label: tbl-raw
#| tbl-cap: "First few rows of the raw dataset"
# Read the dataset from the specified path
data1 <- read_csv(here::here("data1/raw_data/raw_data.csv"))

# Display the first few rows as a formatted table
kable(head(data1))
```
## Data Tools
The whole study is done with R programming language (@citeR). During processing and analyzing the data, multiple of packages are used. For example, 
The data was extracted, cleaned and visualize using R programming language and the whole coding process is done with R (@citeR). Some packages are used throughout the paper, including tidyverse (@cite_tidyverse), ggplot2 (@cite_ggplot), janitor (@citejanitor), OpenDataToronto
(@opendatatorotno), knitr (@cite_knitr), and KableExtra (@cite_kableExtra).

## Data Cleaning

The raw data was first imported from the file and the column names were standardized using the `janitor` package(@citejanitor) to ensure consistency and ease of use throughout the analysis. The next step involved converting the month abbreviations into numeric values to increase the ease of use and analysis. For example, "01" for January, "02" for February.

A new column named `year_month` was generated by concatenating the `year` and `month` columns making it easier to perform time-series analyses and visualizations.

The dataset also included a column named `transgender_non_binary_two_spirit`, which some rows contained non-numeric values (n/a). All `NA` values in this column were replaced with 0 to ensure the data was suitable for statistical analysis and visualization.


Finally, the cleaned dataset was saved to a new file named `analysis_data.csv` in the `analysis_data` directory. It includes the following variables:

- `year`: The year in which the death occurred.
- `month`: The month in which the death occurred, converted to numeric values for ease of analysis.
- `total_decedents`: The total number of deaths recorded in that month.
- `male`: The number of male decedents.
- `female`: The number of female decedents.
- `transgender_non_binary_two_spirit`: The number of decedents identified as transgender, non-binary, or two-spirit. In cases where this information is unavailable, the value is recorded as zero.
- `year_month`: A constructed variable representing the year and month combined, formatted as "year_month" (e.g., 2007_01 for January 2007). 

The @tbl-summary below provides a summary of the cleaned data, showing key statistics (maximum, minimum, mean, median, and variance) for the total number of deaths, as well as for male and female decedents. It highlights that the average number of deaths per month is 4, with males averaging 3 deaths and females 1 death.

```{r}
#| warning: false
#| message: false
#| label: tbl-summary
#| tbl-cap: "Summary of the cleaned data"
# Read the dataset from the specified path
data <- read_csv(here::here("data1/analysis_data/analysis_data.csv"))

# Create a summary table, ignoring NA values, and rounding the results to integers
summary_table <- data.frame(
  Statistic = c("Max", "Min", "Mean", "Median", "Variance"),
  Total = c(round(max(data$total_decedents, na.rm = TRUE)),
            round(min(data$total_decedents, na.rm = TRUE)),
            round(mean(data$total_decedents, na.rm = TRUE)),
            round(median(data$total_decedents, na.rm = TRUE)),
            round(var(data$total_decedents, na.rm = TRUE))),
  Male = c(round(max(data$male, na.rm = TRUE)),
           round(min(data$male, na.rm = TRUE)),
           round(mean(data$male, na.rm = TRUE)),
           round(median(data$male, na.rm = TRUE)),
           round(var(data$male, na.rm = TRUE))),
  Female = c(round(max(data$female, na.rm = TRUE)),
             round(min(data$female, na.rm = TRUE)),
             round(mean(data$female, na.rm = TRUE)),
             round(median(data$female, na.rm = TRUE)),
             round(var(data$female, na.rm = TRUE)))
)

# Display the summary table
kable(summary_table, col.names = c("Statistic", "Total", "Male", "Female"))
```


## Data Visualization and Result
Graphical representations, including line plot, pie chart and bar charts, are used to visualize the trends in the data.These visualizations are critical for understanding the distribution of deaths across different demographic groups and time periods.

```{r}
#| warning: false
#| message: false
#| label: fig-total
#| fig-cap: "Total Number of Deaths by Year (2007-2023)"
# Filter data for the years 2007 to 2023
filtered_data <- data |>
  filter(year >= 2007 & year <= 2023)

# Group by year and summarize the total number of deaths for each year
yearly_deaths <- filtered_data |>
  group_by(year) |>
  summarise(total_deaths = sum(total_decedents, na.rm = TRUE))

# Plot the bar chart
yearly_deaths |>
  ggplot(aes(x = factor(year), y = total_deaths)) +
  geom_bar(stat = "identity", fill = "lightblue") +
  geom_text(aes(label = total_deaths), 
            vjust = -0.5,    # add text
            size = 3,        
            color = "black") +  
  labs(x = "Year",
       y = "Total Number of Deaths") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

This bar chart(@fig-total) displays the total number of deaths among shelter residents in Toronto from 2007 to 2023. The data shows a significant increase in deaths starting from 2019, with a peak in 2021 (132 people). The upward trend continues into 2022 and 2023 (110 and 91 people), though slightly lower than 2021. The data for 2024 has been excluded from this chart as the dataset only covers information up to August 2024.

```{r}
#| warning: false
#| message: false
#| label: fig-category
#| fig-cap: "Death Numbers by Year and Category"

# Summarize the total deaths by year and gender categories
yearly_deaths <- filtered_data |>
  group_by(year) |>
  summarise(
    total_deaths = sum(total_decedents, na.rm = TRUE),
    male_deaths = sum(male, na.rm = TRUE),
    female_deaths = sum(female, na.rm = TRUE),
    trans_deaths = sum(transgender_non_binary_two_spirit)
  )

# Plot the line chart directly using the yearly_deaths dataset
ggplot() +
  geom_line(data = yearly_deaths, aes(x = year, y = total_deaths, color = "Total Deaths")) +
  geom_line(data = yearly_deaths, aes(x = year, y = male_deaths, color = "Male Deaths")) +
  geom_line(data = yearly_deaths, aes(x = year, y = female_deaths, color = "Female Deaths")) +
  geom_line(data = yearly_deaths, aes(x = year, y = trans_deaths, color = "Others")) +
  scale_color_manual(values = c("Total Deaths" = "black", "Male Deaths" = "lightblue", 
                                "Female Deaths" = "lightpink", "Others" = "yellow")) +
  labs(x = "Year",
       y = "Death Number") +
  theme_minimal()
```

```{r}
#| warning: false
#| message: false
#| label: fig-dis
#| fig-cap: "Gender Distribution of Deaths (2007-2023)"

# Summarize the total deaths for each category across all years (2007-2023)
total_sums <- yearly_deaths |>
  summarise(
    Male = sum(male_deaths, na.rm = TRUE),
    Female = sum(female_deaths, na.rm = TRUE),
    Others = sum(trans_deaths, na.rm = TRUE)
  )

# Calculate percentages
total_sums <- total_sums |>
  mutate(
    Male = round(Male / sum(Male, Female, Others) * 100, 1),
    Female = round(Female / sum(Male, Female, Others) * 100, 1),
    Others = round(Others / sum(Male, Female, Others) * 100, 1)
  )

# Convert to a data frame suitable for plotting
category_data <- data.frame(
  category = c("Male", "Female", "Others"),
  percentage = c(total_sums$Male, total_sums$Female, total_sums$Others)
)

# Directly plot the pie chart using base R's pie function
par(mar = c(2, 2, 2, 2)) #adjust the size of the pie
pie(
  c(total_sums$Male, total_sums$Female, total_sums$Others), 
  labels = paste0(c("Male", "Female", "Others"), " (", 
                  c(total_sums$Male, total_sums$Female, total_sums$Others), "%)"), 
  col = c("lightblue", "lightpink", "yellow"),
  border = NA
)

```
@fig-category displays the death trend of each category among shelter residents in Toronto from 2007 to 2023. The data shows a significant increase in deaths starting from 2019 of all three lines, while the yellow line remains at a relatively low level. The total number of deaths equals the sum of male, female, and other gender deaths.The males death rate has consistently been higher than females and the differences is becoming increasingly obvious. The pie chart (@fig-dis) shows the gender distribution of the deaths. 78.2% of the total deaths are from males, while females account for 65.3%. In contrast, individuals of other genders make up only 4.7%.

```{r}
#| warning: false
#| message: false
#| label: fig-month
#| fig-cap: "Total Number of Deaths by Month (2007-2023)"

# total number of deaths for each month
monthly_deaths <- filtered_data |>
  group_by(month) |>
  summarise(total_deaths = sum(total_decedents, na.rm = TRUE))

# Plot the bar chart
ggplot(monthly_deaths, aes(x = factor(month), y = total_deaths)) +
  geom_bar(stat = "identity", fill = "lightblue") +
  labs(
    x = "Month",
    y = "Total Number of Deaths"
  ) +
  scale_x_discrete(labels = 1:12) +
  geom_text(aes(label = total_deaths), # Set x-axis from 1 to 12
            vjust = -0.5,    
            size = 3,        
            color = "black") +
  theme_minimal() 
```
@fig-month illustrates the total number of deaths by month among shelter residents. The highest number of deaths occurred in January which is 80 people, followed by relatively high numbers in November which is 72 people. Conversely, the lowest number of deaths occurred in March and September which is 53 and 51 separatly. There is a slight increase in deaths during the winter months (December to February).


## Model set-up

Define $y_i$ as the number of seconds that the plane remained aloft. Then $\beta_i$ is the wing width and $\gamma_i$ is the wing length, both measured in millimeters.  

\begin{align} 
y_i|\mu_i, \sigma &\sim \mbox{Normal}(\mu_i, \sigma) \\
\mu_i &= \alpha + \beta_i + \gamma_i\\
\alpha &\sim \mbox{Normal}(0, 2.5) \\
\beta &\sim \mbox{Normal}(0, 2.5) \\
\gamma &\sim \mbox{Normal}(0, 2.5) \\
\sigma &\sim \mbox{Exponential}(1)
\end{align}

We run the model in R [@citeR] using the `rstanarm` package of @rstanarm. We use the default priors from `rstanarm`.


### Model justification

We expect a positive relationship between the size of the wings and time spent aloft. In particular...

We can use maths by including latex between dollar signs, for instance $\theta$.


# Results

Our results are summarized in @tbl-modelresults.





# Discussion

## First discussion point {#sec-first-point}

If my paper were 10 pages, then should be be at least 2.5 pages. The discussion is a chance to show off what you know and what you learnt from all this. 

## Second discussion point

## Third discussion point

## Weaknesses and next steps

Weaknesses and next steps should also be included.

\newpage

\appendix

# Appendix {-}


# Additional data details

# Model details {#sec-model-details}

## Posterior predictive check


## Diagnostics

@fig-stanareyouokay-1 is a trace plot. It shows... This suggests...

@fig-stanareyouokay-2 is a Rhat plot. It shows... This suggests...



\newpage


# References


